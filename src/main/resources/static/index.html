<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>bdr Hackathon VR/AR Application</title>
  <meta name="description" content="Hello, WebVR! â€¢ A-Frame">
  <script src="https://aframe.io/releases/1.0.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-slice9-component/dist/aframe-slice9-component.min.js"></script>
  <!-- <script src="https://rawgit.com/mayognaise/aframe-mouse-cursor-component/master/dist/aframe-mouse-cursor-component.min.js"></script> -->
  <script src="https://unpkg.com/aframe-look-at-component@0.8.x/dist/aframe-look-at-component.min.js"></script>


  <script>

    AFRAME.registerComponent('chess-board', {
      init: function () {

        // inside an a-frame component
        var acamera = document.querySelector("#a-camera")
        var scene = document.querySelector('a-scene');
        var chessboard = document.querySelector('[chess-board]');
        var direction = new THREE.Vector3();

        // move forward in camera direction for mouse scroll wheel
        window.addEventListener("wheel", event => {
          const delta = Math.sign(event.wheelDelta) * 3;
          // getting the mouse wheel change (120 or -120 and normalizing it to 1 or -1)

          // get the cameras world direction
          this.el.sceneEl.camera.getWorldDirection(direction);
          direction.multiplyScalar(0.1);

          var pos = acamera.object3D.position;
          pos.x += delta * direction.x;
          pos.y += delta * direction.y
          pos.z += delta * direction.z;
        });


        for (let index = 0; index < 8; index++) {
          var figure = document.createElement('a-entity');
          figure.setAttribute('id', 'pawn' + index);
          figure.object3D.position.set(-11.5 + index * 1.65, 0, 8);
          figure.setAttribute('material', { color: 'red' });
          figure.setAttribute('gltf-model', '#pawn');
          figure.setAttribute('modify-chess-figure', '');
          figure.setAttribute('shadow', { cast: true, receive: true })

          var overlay = document.createElement('a-entity');
          figure.appendChild(overlay);
          overlay.setAttribute('id', 'pawn-overlay' + index);
          overlay.setAttribute('overlay', '');
          overlay.object3D.position.set(6, 4, -4);
          overlay.setAttribute('text', 'color: #4ef580; width: 6; x-offset: 1; value: The eggs have been found!\nExplore the OASIS!;');
          overlay.setAttribute('slice9', { color: '#111', width: 5, height: 3 });
          overlay.setAttribute('look-at', '[camera]');
          overlay.setAttribute('visible', 'false');
          overlay.setAttribute('mixin', 'slice');

          figure.addEventListener('click', function (evt) {
            var figureOverlay = document.querySelector('#pawn-overlay' + index);
            var isVisible = figureOverlay.object3D.visible;

            var allOverlays = scene.querySelectorAll('[overlay]');
            for (var i = 0; i < allOverlays.length; i++) {
              allOverlays[i].object3D.visible = false;
            }

            figureOverlay.object3D.visible = !isVisible;
          });

          overlay.addEventListener('click', function (evt) {
            evt.stopPropagation();
          });

          chessboard.appendChild(figure);


          // this.el.addEventListener('click', function (evt) {
          //   // this.setAttribute('material', 'color', '#FFF');
          //   var vectorChessFig = this.getAttribute('position');

          //   this.setAttribute('position', { x: vectorChessFig.x + 4, y: vectorChessFig.y, z: vectorChessFig.z });
          // });
        }
      }
    });
  </script>
</head>

<body>
  <a-scene>
    <a-assets>
      <img id="sliceImg" src="/assets/img/slice.png">
      <a-mixin id="slice" slice9="color: #050505; src: #sliceImg; left: 50; right: 52; top: 50; bottom: 52;"></a-mixin>
      <a-asset-item id="chess-board-model" src="/assets/models/chess-board.glb"></a-asset-item>
      <a-asset-item id="pawn" src="/assets/models/fig_bauer-w.glb"></a-asset-item>
    </a-assets>
    <a-entity chess-board gltf-model="#chess-board-model"></a-entity>

    <a-entity id="rig" wasd-controls  position="0 7.8 10" rotation="-40 0 0">
      <a-entity camera look-controls id="a-camera" cursor="rayOrigin: mouse" />
    </a-entity>

  </a-scene>
</body>

</html>